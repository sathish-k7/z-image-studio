<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Z-Image Studio</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <style>
        body { background-color: #f8f9fa; }
        .preview-area {
            min-height: 400px;
            background: #e9ecef;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            border: 2px dashed #ced4da;
            cursor: pointer; /* Add cursor pointer to indicate clickable */
        }
        .preview-area img {
            max-width: 100%;
            max-height: 75vh;
            border-radius: 4px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            cursor: pointer; /* Also for the image itself */
        }
        .loading-spinner {
            width: 3rem;
            height: 3rem;
        }
        .lang-switch {
            position: absolute;
            top: 1rem;
            right: 1rem;
            z-index: 1000;
        }
        .tooltip-icon {
            cursor: pointer;
        }
        /* Style for the modal image to ensure it fits the screen */
        .modal-dialog-custom {
            max-width: 95vw;
            margin: 1rem auto;
        }
        .modal-content-custom {
            background: transparent;
            border: none;
            box-shadow: none;
        }
        .modal-body-custom {
            padding: 0;
            position: relative;
            text-align: center;
        }
        .modal-image-full {
            max-height: 90vh;
            max-width: 100%;
            width: auto;
            display: inline-block;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            border-radius: 4px;
        }
        .close-btn-custom {
            position: absolute;
            top: -15px;
            right: -15px;
            z-index: 1060;
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            color: white;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            padding: 0;
        }
        .close-btn-custom:hover {
            background: rgba(255, 255, 255, 0.4);
            transform: scale(1.1);
        }
        .delete-history-item {
            color: #6c757d;
            border: 1px solid transparent;
            transition: all 0.2s;
            padding: 0.25rem 0.5rem; /* Bootstrap's py-1 px-2 approx */
            align-self: center; 
        }
        .delete-history-item:not(.btn-danger):hover {
            color: #dc3545 !important;
            border-color: #dc3545;
            background: rgba(220, 53, 69, 0.05);
        }
        
        /* --- History Sidebar Styles --- */
        .history-sidebar-col {
            display: none; /* Hidden by default */
            border-right: 1px solid #dee2e6;
            background: #fff;
            height: calc(100vh - 2rem); /* Approx full height minus padding */
            overflow-y: auto;
            position: sticky;
            top: 1rem;
            border-radius: 8px;
            box-shadow: 0 .125rem .25rem rgba(0,0,0,.075);
        }

        /* When pinned mode is active (Desktop only) */
        @media (min-width: 992px) {
            body.history-pinned .history-sidebar-col {
                display: block;
            }
            body.history-pinned .controls-col {
                width: 25%; /* Shrink controls slightly */
                .top-buttons {
                    min-height: 1.95rem; /* Keep height consistent */
                }
            }
            body.history-pinned .preview-col {
                width: 50%; /* Shrink preview slightly */
            }
            /* Hide the offcanvas toggle button when pinned */
            body.history-pinned .offcanvas-toggle-btn {
                display: none !important;
            }
        }
        /* When pinned mode is active (Desktop only) */
        @media (max-width: 1024px) {
            body.history-pinned .preview-col {
                .header-title {
                    font-size: 1.2rem;
                    margin-top: 0.55rem;
                }
                .header-subtitle {
                    font-size: 0.8rem;
                }
            }
        }
        .history-item-active {
            background-color: #e9ecef;
            border-left: 4px solid #0d6efd;
        }
    </style>
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <link rel="apple-touch-icon" sizes="180x180" href="/logo-180.png">
</head>
<body>
    <!-- Language Selector -->
    <div class="lang-switch d-flex gap-2">
        <select class="form-select form-select-sm" id="languageSelect">
            <option value="en">ðŸ‡ºðŸ‡¸ English</option>
            <option value="zh">ðŸ‡¨ðŸ‡³ ä¸­æ–‡</option>
            <option value="jp">ðŸ‡¯ðŸ‡µ æ—¥æœ¬èªž</option>
        </select>
    </div>

    <div class="container-fluid px-4 py-4"> <!-- Changed to fluid for better 3-col layout -->
        <!-- Mobile-only Header -->
        <header class="text-center mt-1 mb-3 d-lg-none">
            <h3 class="fw-bold text-primary">Z-Image Studio</h3>
            <p class="text-secondary" data-i18n="subtitle">Local High-Quality Image Generation</p>
        </header>

        <div class="row g-4">
            <!-- History Sidebar Column (Visible only when pinned on Desktop) -->
            <div class="col-lg-3 history-sidebar-col ps-0 pe-0" id="historySidebarContainer">
                <div class="p-3 pt-2 border-bottom d-flex justify-content-between align-items-center bg-light sticky-top">
                    <h5 class="mb-0" data-i18n="history_title">History</h5>
                    <button class="btn btn-sm btn-outline-primary active" id="unpinHistoryBtn" title="Unpin History">
                        <i class="bi bi-pin-angle-fill"></i>
                    </button>
                </div>
                <div id="historyListSidebar" class="list-group list-group-flush">
                    <!-- History items injected here when pinned -->
                </div>
            </div>

            <!-- Controls Column (Left) -->
            <div class="col-lg-4 controls-col">
                <div class="d-flex justify-content-start mt-2 mb-3 gap-2 top-buttons">
                    <button class="btn btn-outline-secondary btn-sm offcanvas-toggle-btn" type="button" data-bs-toggle="offcanvas" data-bs-target="#historyDrawer" aria-controls="historyDrawer" data-i18n="history_btn">
                        History
                    </button>
                    <button class="btn btn-outline-warning btn-sm d-none" type="button" id="restoreDraftBtn" data-i18n="restore_draft_btn">
                        Restore Last Draft
                    </button>
                    <button class="btn btn-outline-warning btn-sm d-none" type="button">
                        &nbsp;
                    </button>
                </div>
                <div class="card shadow-sm">
                    <div class="card-body">
                        <h5 class="card-title mb-4" data-i18n="settings_title">Settings</h5>
                        <form id="generateForm">
                            <div class="mb-3">
                                <label for="prompt" class="form-label fw-bold" data-i18n="prompt_label">Prompt</label>
                                <textarea class="form-control" id="prompt" rows="6" placeholder="Describe your image..." data-i18n-placeholder="prompt_placeholder" data-i18n-value="default_prompt" required></textarea>
                            </div>

                            <div class="row mb-3">
                                <div class="col">
                                    <label for="width" class="form-label" data-i18n="width_label">Width</label>
                                    <input type="number" class="form-control" id="width" value="1280" step="16" min="16">
                                </div>
                                <div class="col">
                                    <label for="height" class="form-label" data-i18n="height_label">Height</label>
                                    <input type="number" class="form-control" id="height" value="720" step="16" min="16">
                                </div>
                            </div>
                            
                                                        <div class="mb-3">
                                                            <label class="form-label" data-i18n="seed_label">Seed</label>
                                                            <div class="d-flex align-items-center flex-wrap gap-3 mb-2">
                                                                <div class="form-check">
                                                                    <input class="form-check-input " type="radio" name="seedMode" id="seedRandom" value="random" checked>
                                                                    <label class="form-check-label ms-1 me-2" for="seedRandom" data-i18n="seed_random">Random</label>
                                                                </div>
                                                                <div class="form-check d-flex align-items-center">
                                                                    <input class="form-check-input" type="radio" name="seedMode" id="seedFixed" value="fixed">
                                                                    <label class="form-check-label ms-1 me-2" for="seedFixed" data-i18n="seed_fixed">Fixed</label>
                                                                    <input type="number" class="form-control" id="seedInput" placeholder="Enter seed..." disabled style="width: 136px;">
                                                                </div>
                                                            </div>
                                                        </div>
                                                        
                                                        <div class="mb-3">
                                                            <label for="precision" class="form-label" data-i18n="precision_label">Model Precision</label>
                                                            <select class="form-select" id="precision">
                                                                <option value="full" data-i18n="precision_full">Best and slower</option>
                                                                <option value="q8" data-i18n="precision_q8">Great and faster</option>
                                                                <option value="q4" data-i18n="precision_q4">Faster and Great</option>
                                                            </select>
                                                        </div>

                                                        <div class="mb-3">
                                                            <label for="steps" class="form-label">                                    <span data-i18n="steps_label">Steps</span>: <span id="stepsVal">9</span>
                                    <span class="d-inline-block ms-2 tooltip-icon" tabindex="0" data-bs-toggle="tooltip" data-bs-placement="top" data-i18n-title="steps_tooltip">
                                        <i class="bi bi-question-circle"></i>
                                    </span>
                                </label>
                                <input type="range" class="form-range" id="steps" min="1" max="50" value="9">
                            </div>

                            <button type="submit" class="btn btn-primary w-100 py-2 fw-bold" id="generateBtn" data-i18n="generate_btn">
                                Generate Image
                            </button>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Preview Column (Right) -->
            <div class="col-lg-8 preview-col">
                <!-- Desktop-only Header -->
                <header class="text-start mt-1 mb-3 d-none d-lg-flex align-items-baseline">
                    <h3 class="fw-bold text-primary mb-0 header-title">Z-Image Studio</h3>
                    <p class="text-secondary ms-3 mb-0 header-subtitle" data-i18n="subtitle">Local High-Quality Image Generation</p>
                </header>
                <div class="card shadow-sm">
                    <div class="card-body d-flex flex-column">
                        <h5 class="card-title mb-3" data-i18n="preview_title">Preview</h5>
                        <div class="preview-area mb-3" id="previewContainer">
                            <span class="text-muted" data-i18n="preview_placeholder">Image will appear here</span>
                        </div>
                        
                        <div id="resultInfo" class="d-none border-top pt-3">
                            <div class="d-flex justify-content-between align-items-center">
                                <div class="text-muted small">
                                    <span id="timeTaken"></span>
                                    <span class="mx-2">|</span>
                                    <span id="metaDims"></span>
                                    <span class="mx-2">|</span>
                                    <span id="metaSize"></span>
                                    <span class="mx-2">|</span>
                                    <span id="metaSeed"></span>
                                    <span class="mx-2">|</span>
                                    <span id="metaPrecision"></span>
                                    <span class="mx-2">|</span>
                                    <span id="metaSteps"></span>
                                </div>
                                <a href="#" id="downloadBtn" class="btn btn-success" download data-i18n="download_btn">Download Image</a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- History Drawer (Offcanvas) -->
    <div class="offcanvas offcanvas-start" tabindex="-1" id="historyDrawer" aria-labelledby="historyDrawerLabel">
        <div class="offcanvas-header">
            <h5 class="offcanvas-title" id="historyDrawerLabel" data-i18n="history_title">History</h5>
            <div class="d-flex align-items-center gap-2">
                <!-- Pin Button for Desktop -->
                <button type="button" class="btn btn-sm btn-outline-secondary d-none d-lg-block" id="pinHistoryBtn" title="Pin History Sidebar">
                    <i class="bi bi-pin-angle"></i>
                </button>
                <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
            </div>
        </div>
        <div class="offcanvas-body">
            <div id="historyList" class="list-group list-group-flush">
                <!-- History items will be injected here -->
            </div>
        </div>
    </div>

    <!-- Image Modal -->
    <div class="modal fade" id="imageModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-custom modal-dialog-centered">
            <div class="modal-content modal-content-custom">
                <div class="modal-body modal-body-custom">
                    <button type="button" class="close-btn-custom" data-bs-dismiss="modal" aria-label="Close">
                        <i class="bi bi-x-lg"></i>
                    </button>
                    <img id="modalImage" src="" alt="Generated Image Preview" class="modal-image-full">
                </div>
            </div>
        </div>
    </div>

    <script>
        const form = document.getElementById('generateForm');
        const stepsInput = document.getElementById('steps');
        const stepsVal = document.getElementById('stepsVal');
        const generateBtn = document.getElementById('generateBtn');
        const previewContainer = document.getElementById('previewContainer');
        const resultInfo = document.getElementById('resultInfo');
        const downloadBtn = document.getElementById('downloadBtn');
        const timeTaken = document.getElementById('timeTaken');
        const metaDims = document.getElementById('metaDims');
        const metaSize = document.getElementById('metaSize');
        const metaSeed = document.getElementById('metaSeed');
        const languageSelect = document.getElementById('languageSelect');
        const metaPrecision = document.getElementById('metaPrecision');
        const metaSteps = document.getElementById('metaSteps');
        const imageModal = new bootstrap.Modal(document.getElementById('imageModal'));
        const modalImage = document.getElementById('modalImage');
        const historyListOffcanvas = document.getElementById('historyList');
        const historyListSidebar = document.getElementById('historyListSidebar');
        const restoreDraftBtn = document.getElementById('restoreDraftBtn');
        
        // Pinning UI Elements
        const pinHistoryBtn = document.getElementById('pinHistoryBtn');
        const unpinHistoryBtn = document.getElementById('unpinHistoryBtn');
        const historyDrawerEl = document.getElementById('historyDrawer');
        const historyDrawer = new bootstrap.Offcanvas(historyDrawerEl);

        let isDirty = false;
        let timerInterval;
        let isHistoryPinned = localStorage.getItem('zimage_history_pinned') === 'true';

        // Apply initial pin state
        if (isHistoryPinned) {
            document.body.classList.add('history-pinned');
        }

        function toggleHistoryPin(shouldPin) {
            isHistoryPinned = shouldPin;
            localStorage.setItem('zimage_history_pinned', shouldPin);
            
            if (shouldPin) {
                document.body.classList.add('history-pinned');
                historyDrawer.hide(); // Hide offcanvas if it's open
            } else {
                document.body.classList.remove('history-pinned');
            }
            // Reload history to ensure the correct container is populated/updated
            loadHistory();
        }

        pinHistoryBtn.addEventListener('click', () => toggleHistoryPin(true));
        unpinHistoryBtn.addEventListener('click', () => toggleHistoryPin(false));

        // Helper function to format number with max one decimal, trimming .0
        function formatValueWithOneDecimal(value) {
            if (value === null || typeof value === 'undefined') return '';
            const fixed = value.toFixed(1);
            return parseFloat(fixed); // Removes trailing .0 if present
        }

        // Helper function to format file size smartly
        function formatFileSize(file_size_kb, lang) {
            const t = translations[lang];
            if (file_size_kb >= 1024) {
                return t.meta_size_mb.replace('{0}', formatValueWithOneDecimal(file_size_kb / 1024));
            } else {
                return t.meta_size.replace('{0}', formatValueWithOneDecimal(file_size_kb));
            }
        }

        function formatSmartDate(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            const yesterday = new Date(today);
            yesterday.setDate(yesterday.getDate() - 1);
            const itemDate = new Date(date.getFullYear(), date.getMonth(), date.getDate());

            if (itemDate.getTime() === today.getTime()) {
                return date.toLocaleTimeString();
            } else if (itemDate.getTime() === yesterday.getTime()) {
                const t = translations[languageSelect.value];
                const yesterdayText = t.yesterday || "Yesterday";
                return yesterdayText + ", " + date.toLocaleTimeString();
            } else {
                return date.toLocaleString();
            }
        }

        // i18n Configuration
        const translations = {
            en: {
                subtitle: "Local High-Quality Image Generation",
                settings_title: "Settings",
                prompt_label: "Prompt",
                prompt_placeholder: "Describe your image...",
                steps_label: "Steps",
                width_label: "Width",
                height_label: "Height",
                seed_label: "Seed",
                seed_random: "Random",
                seed_fixed: "Fixed",
                precision_label: "Model Precision",
                precision_full: "Best and slower (full)",
                precision_q8: "Great and faster (q8)",
                precision_q4: "Faster and Good (q4)",
                steps_tooltip: "Sampling steps determine image quality. 9 is fast, 15-25 for better quality. Advanced users only.",
                generate_btn: "Generate Image",
                generating_btn: "Generating...",
                preview_title: "Preview",
                preview_placeholder: "Image will appear here",
                download_btn: "Download Image",
                time_taken: "{0}s",
                meta_size: "{0} KB",
                meta_size_mb: "{0} MB",
                modal_title: "Generated Image",
                history_btn: "History",
                history_title: "History",
                history_empty: "No history yet.",
                restore_draft_btn: "Restore Last Draft",
                delete_btn_tooltip: "Delete",
                confirm_delete: "Are you sure you want to delete this generation?",
                default_prompt: "A futuristic cyberpunk city at night, neon lights, realistic",
                yesterday: "Yesterday"
            },
            zh: {
                subtitle: "æœ¬åœ°é«˜è´¨é‡å›¾åƒç”Ÿæˆ",
                settings_title: "è®¾ç½®",
                prompt_label: "æç¤ºè¯",
                prompt_placeholder: "æè¿°ä½ æƒ³è¦çš„ç”»é¢...",
                steps_label: "æ­¥æ•°",
                width_label: "å®½åº¦",
                height_label: "é«˜åº¦",
                seed_label: "ç§å­ (Seed)",
                seed_random: "éšæœº",
                seed_fixed: "å›ºå®š",
                precision_label: "æ¨¡åž‹ç²¾åº¦",
                precision_full: "æœ€ä½³ç”»è´¨ä½†è¾ƒæ…¢ ( full)",
                precision_q8: "ä¼˜ç§€ç”»è´¨ä¸”è¾ƒå¿« (è¾ƒå¿« q8)",
                precision_q4: "å¾ˆå¿«ä½†ç”»è´¨ç•¥å·® (q4)",
                steps_tooltip: "é‡‡æ ·æ­¥æ•°å†³å®šå›¾åƒè´¨é‡ã€‚9æ­¥å¾ˆå¿«ï¼Œ15-25æ­¥å¯èŽ·å¾—æ›´å¥½è´¨é‡ã€‚å»ºè®®é«˜çº§ç”¨æˆ·è°ƒæ•´ã€‚",
                generate_btn: "ç”Ÿæˆå›¾ç‰‡",
                generating_btn: "ç”Ÿæˆä¸­...",
                preview_title: "é¢„è§ˆ",
                preview_placeholder: "ç”Ÿæˆçš„å›¾ç‰‡å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ",
                download_btn: "ä¸‹è½½å›¾ç‰‡",
                time_taken: "{0}ç§’",
                meta_size: "{0} KB",
                meta_size_mb: "{0} MB",
                modal_title: "ç”Ÿæˆå›¾ç‰‡",
                history_btn: "åŽ†å²è®°å½•",
                history_title: "ç”ŸæˆåŽ†å²",
                history_empty: "æš‚æ— è®°å½•",
                restore_draft_btn: "æ¢å¤è‰ç¨¿",
                delete_btn_tooltip: "åˆ é™¤",
                confirm_delete: "ç¡®å®šè¦åˆ é™¤æ­¤ç”Ÿæˆè®°å½•å—ï¼Ÿ",
                default_prompt: "å¤œæ™šçš„æœªæ¥èµ›åšæœ‹å…‹åŸŽå¸‚ï¼Œéœ“è™¹ç¯ï¼Œå†™å®ž",
                yesterday: "æ˜¨å¤©"
            },
            jp: {
                subtitle: "é«˜å“è³ªãªç”»åƒç”Ÿæˆï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ï¼‰",
                settings_title: "è¨­å®š",
                prompt_label: "ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ",
                prompt_placeholder: "ç”»åƒã®èª¬æ˜Žã‚’å…¥åŠ›ã—ã¦ãã ã•ã„...",
                steps_label: "ã‚¹ãƒ†ãƒƒãƒ—æ•°",
                width_label: "å¹…",
                height_label: "é«˜ã•",
                seed_label: "ã‚·ãƒ¼ãƒ‰å€¤",
                seed_random: "ãƒ©ãƒ³ãƒ€ãƒ ",
                seed_fixed: "å›ºå®š",
                precision_label: "ãƒ¢ãƒ‡ãƒ«ç²¾åº¦",
                precision_full: "æœ€é«˜ç”»è³ª (é…ã„ full)",
                precision_q8: "é«˜ç”»è³ª (é€Ÿã„ q8)",
                precision_q4: "é«˜é€Ÿ (q4)",
                steps_tooltip: "ã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°ã‚¹ãƒ†ãƒƒãƒ—æ•°ã¯ç”»åƒã®å“è³ªã‚’æ±ºå®šã—ã¾ã™ã€‚9ã‚¹ãƒ†ãƒƒãƒ—ã¯é«˜é€Ÿã§ã™ãŒã€15ï½ž25ã‚¹ãƒ†ãƒƒãƒ—ã§ã‚ˆã‚Šé«˜å“è³ªã«ãªã‚Šã¾ã™ã€‚ä¸Šç´šè€…å‘ã‘ã§ã™ã€‚",
                generate_btn: "ç”»åƒã‚’ç”Ÿæˆ",
                generating_btn: "ç”Ÿæˆä¸­...",
                preview_title: "ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼",
                preview_placeholder: "ç”»åƒãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™",
                download_btn: "ç”»åƒã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰",
                time_taken: "{0}ç§’",
                meta_size: "{0} KB",
                meta_size_mb: "{0} MB",
                modal_title: "ç”Ÿæˆã•ã‚ŒãŸç”»åƒ",
                history_btn: "å±¥æ­´",
                history_title: "ç”Ÿæˆå±¥æ­´",
                history_empty: "å±¥æ­´ãªã—",
                restore_draft_btn: "ä¸‹æ›¸ãã‚’å¾©å…ƒ",
                delete_btn_tooltip: "å‰Šé™¤",
                confirm_delete: "ã“ã®ç”Ÿæˆã‚’å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ",
                default_prompt: "æœªæ¥çš„ãªã‚µã‚¤ãƒãƒ¼ãƒ‘ãƒ³ã‚¯éƒ½å¸‚ã®å¤œã€ãƒã‚ªãƒ³ãƒ©ã‚¤ãƒˆã€ãƒªã‚¢ãƒ«",
                yesterday: "æ˜¨æ—¥"
            }
        };

        function updateLanguage(lang) {
            const t = translations[lang];
            
            // Update Text Content
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if (t[key]) el.textContent = t[key];
            });

            // Update Placeholders
            document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
                const key = el.getAttribute('data-i18n-placeholder');
                if (t[key]) el.placeholder = t[key];
            });

            // Update Tooltip Titles
            document.querySelectorAll('[data-i18n-title]').forEach(el => {
                const key = el.getAttribute('data-i18n-title');
                if (t[key]) el.setAttribute('title', t[key]);
            });
            
            // No more modal title to update

            // Save preference
            localStorage.setItem('zimage_lang', lang);
            
            // Update Input Values (like default prompt)
            document.querySelectorAll('[data-i18n-value]').forEach(el => {
                const key = el.getAttribute('data-i18n-value');
                if (t[key]) {
                    // Only set if prompt isn't already loaded from localStorage or user input
                    if (el.id === 'prompt' && localStorage.getItem('zimage_prompt')) {
                        // Do nothing, localStorage takes precedence
                    } else {
                        el.value = t[key];
                    }
                }
            });
            
            // Handle dynamic state text (like button loading state if active)
            if (generateBtn.disabled) {
                 generateBtn.textContent = t.generating_btn;
            }
        }

        // Init Language
        let initialLang = localStorage.getItem('zimage_lang');
        if (!initialLang) {
            const browserLang = navigator.language;
            if (browserLang.startsWith('zh')) {
                initialLang = 'zh';
            } else if (browserLang.startsWith('ja')) {
                initialLang = 'jp';
            } else {
                initialLang = 'en';
            }
        }
        languageSelect.value = initialLang;
        updateLanguage(initialLang);

        languageSelect.addEventListener('change', (e) => {
            updateLanguage(e.target.value);
            // Reinitialize tooltips after language change to update titles
            var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
            var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
              return new bootstrap.Tooltip(tooltipTriggerEl);
            });
        });

        // --- Persistence Logic (Restored) ---
        const promptInput = document.getElementById('prompt');
        const widthInput = document.getElementById('width');
        const heightInput = document.getElementById('height');
        const seedInput = document.getElementById('seedInput');
        const seedRandomRadio = document.getElementById('seedRandom');
        const seedFixedRadio = document.getElementById('seedFixed');
        const precisionInput = document.getElementById('precision');

        // Load saved values
        if (localStorage.getItem('zimage_prompt')) promptInput.value = localStorage.getItem('zimage_prompt');
        
        if (localStorage.getItem('zimage_steps')) {
            const savedSteps = localStorage.getItem('zimage_steps');
            stepsInput.value = savedSteps;
            stepsVal.textContent = savedSteps;
        }

        if (localStorage.getItem('zimage_width')) widthInput.value = localStorage.getItem('zimage_width');
        if (localStorage.getItem('zimage_height')) heightInput.value = localStorage.getItem('zimage_height');
        
        if (localStorage.getItem('zimage_precision')) {
            precisionInput.value = localStorage.getItem('zimage_precision');
        } else {
            precisionInput.value = 'q8'; // Default
        }

        // Load saved Seed State
        const savedSeedMode = localStorage.getItem('zimage_seed_mode');
        if (savedSeedMode === 'fixed') {
            seedFixedRadio.checked = true;
            const savedSeedValue = localStorage.getItem('zimage_seed_value');
            if (savedSeedValue) {
                seedInput.value = savedSeedValue;
            }
        } else {
            // Default to random if no explicit fixed mode or if saved mode is random
            seedRandomRadio.checked = true;
        }
        updateSeedState(); // Apply disabled state based on loaded mode

        // Seed State Logic
        function updateSeedState() {
            if (seedFixedRadio.checked) {
                seedInput.disabled = false;
                // If empty when switching to fixed, generate a random one as a starting point
                if (!seedInput.value) {
                     seedInput.value = Math.floor(Math.random() * 1000000000);
                }
                localStorage.setItem('zimage_seed_mode', 'fixed');
                localStorage.setItem('zimage_seed_value', seedInput.value);
            } else {
                seedInput.disabled = true;
                localStorage.setItem('zimage_seed_mode', 'random');
                localStorage.removeItem('zimage_seed_value'); // Clear value if random
            }
        }

        seedRandomRadio.addEventListener('change', updateSeedState);
        seedFixedRadio.addEventListener('change', updateSeedState);
        seedInput.addEventListener('input', () => { // Save seed value when input changes
            if (seedFixedRadio.checked) { // Only save if fixed mode is active
                localStorage.setItem('zimage_seed_value', seedInput.value);
            }
            isDirty = true;
        });
        
        precisionInput.addEventListener('change', (e) => {
            localStorage.setItem('zimage_precision', e.target.value);
            isDirty = true;
        });

        // Save on change
        promptInput.addEventListener('input', (e) => {
            localStorage.setItem('zimage_prompt', e.target.value);
            isDirty = true;
        });
        
        stepsInput.addEventListener('input', (e) => {
            stepsVal.textContent = e.target.value;
            localStorage.setItem('zimage_steps', e.target.value);
            isDirty = true;
        });

        // Enforce multiples of 16 for dimensions + Save
        ['width', 'height'].forEach(id => {
            const el = document.getElementById(id);
            el.addEventListener('change', (e) => {
                let val = parseInt(e.target.value);
                if (isNaN(val)) val = 1280;
                // Snap to nearest multiple of 16
                val = Math.round(val / 16) * 16;
                if (val < 16) val = 16;
                e.target.value = val;
                
                // Save to storage
                localStorage.setItem(`zimage_${id}`, val);
                isDirty = true;
            });
        });

        // --- History Logic ---
        let historyOffset = 0;
        const historyLimit = 20;
        let historyTotal = 0;
        let isHistoryLoading = false;
        let historyObserver;

        async function loadHistory(append = false) {
            if (isHistoryLoading) return;
            
            if (!append) {
                historyOffset = 0;
                historyTotal = 0;
                // Clear lists immediately if reloading from scratch
                historyListOffcanvas.innerHTML = '';
                historyListSidebar.innerHTML = '';
            }

            isHistoryLoading = true;

            // Remove sentinel if it exists (so we don't trigger it while loading)
            removeSentinels();

            try {
                const res = await fetch(`/history?limit=${historyLimit}&offset=${historyOffset}`);
                
                // Read headers
                const totalStr = res.headers.get('X-Total-Count');
                if (totalStr) historyTotal = parseInt(totalStr);

                const items = await res.json();
                renderHistory(items, append);
                
                // Update offset for next batch
                historyOffset += items.length;

                // Re-attach sentinel if we have more data
                if (historyOffset < historyTotal) {
                    addSentinels();
                }

            } catch (e) {
                console.error("Failed to load history", e);
            } finally {
                isHistoryLoading = false;
            }
        }

        function removeSentinels() {
             document.querySelectorAll('.history-sentinel').forEach(el => el.remove());
        }

        function addSentinels() {
            // Add sentinel to BOTH lists
            [historyListOffcanvas, historyListSidebar].forEach(container => {
                const sentinel = document.createElement('div');
                sentinel.className = 'history-sentinel p-3 text-center text-muted small';
                sentinel.textContent = 'Loading more...';
                container.appendChild(sentinel);
                if (historyObserver) historyObserver.observe(sentinel);
            });
        }

        function renderHistory(items, append) {
            const containers = [historyListOffcanvas, historyListSidebar];

            if (items.length === 0 && !append) {
                const emptyMsg = `<div class="text-center text-muted p-3" data-i18n="history_empty">${translations[languageSelect.value].history_empty}</div>`;
                containers.forEach(c => c.innerHTML = emptyMsg);
                return;
            }

            items.forEach(item => {
                const date = formatSmartDate(item.created_at);
                const shortPrompt = item.prompt.length > 60 ? item.prompt.substring(0, 60) + '...' : item.prompt;
                const imageUrl = `/outputs/${item.filename}`;
                
                // Using HTML string for easier dual-appending
                const itemHtml = `
                    <a href="#" class="list-group-item list-group-item-action d-flex gap-3 py-3 history-item-link">
                        <img src="${imageUrl}" alt="thumb" width="80" height="80" class="rounded object-fit-cover flex-shrink-0 bg-light" loading="lazy">
                        <div class="d-flex flex-column gap-1 w-100" style="min-width: 0;">
                            <h6 class="mb-0 small text-truncate">${shortPrompt}</h6>
                            <p class="mb-0 opacity-75 small">${item.width}x${item.height} Â· ${formatFileSize(item.file_size_kb, languageSelect.value)}</p>
                            <small class="text-muted" style="line-height: 0.9rem">${date}</small>
                            <small class="text-muted" style="line-height: 0.9rem">${formatValueWithOneDecimal(item.generation_time)}s Â· ${item.precision} Â· ${item.steps} steps</small>
                        </div>
                        <button class="btn btn-sm btn-outline-secondary ms-auto delete-history-item" data-id="${item.id}" title="${translations[languageSelect.value].delete_btn_tooltip}">
                            <i class="bi bi-trash"></i>
                        </button>
                    </a>
                `;

                containers.forEach(container => {
                    // Create a temp div to parse HTML
                    const temp = document.createElement('div');
                    temp.innerHTML = itemHtml;
                    const el = temp.firstElementChild;
                    
                    el.onclick = (e) => {
                        // Only trigger load if not clicking delete button
                        if (!e.target.closest('.delete-history-item')) {
                            e.preventDefault();
                            loadFromHistory(item);
                        }
                    };

                    // Add delete handler
                    const delBtn = el.querySelector('.delete-history-item');
                    delBtn.onclick = async (e) => {
                        e.stopPropagation(); 
                        e.preventDefault();
                        const btn = e.currentTarget;
                        if (btn.dataset.armed === "true") {
                            await deleteHistoryItem(item.id);
                        } else {
                            btn.dataset.armed = "true";
                            btn.classList.remove('btn-outline-secondary');
                            btn.classList.add('btn-danger');
                            btn.innerHTML = '<i class="bi bi-trash-fill"></i>';
                            setTimeout(() => {
                                if (document.body.contains(btn)) {
                                    btn.dataset.armed = "false";
                                    btn.classList.remove('btn-danger');
                                    btn.classList.add('btn-outline-secondary');
                                    btn.innerHTML = '<i class="bi bi-trash"></i>';
                                }
                            }, 3000);
                        }
                    };

                    container.appendChild(el);
                });
            });
        }

        async function deleteHistoryItem(itemId) {
            try {
                const res = await fetch(`/history/${itemId}`, {
                    method: 'DELETE'
                });
                if (!res.ok) throw new Error('Failed to delete history item');
                loadHistory(); // Reload history after deletion (resets to page 1)
            } catch (e) {
                console.error("Error deleting history item:", e);
                alert("Failed to delete item.");
            }
        }

        // Initialize Intersection Observer
        historyObserver = new IntersectionObserver((entries) => {
            if (entries[0].isIntersecting && !isHistoryLoading) {
                loadHistory(true); // Load next page
            }
        }, { rootMargin: '200px' });

        function loadFromHistory(item) {
            // Auto-stash if dirty
            if (isDirty) {
                localStorage.setItem('zimage_stash_prompt', promptInput.value);
                localStorage.setItem('zimage_stash_steps', stepsInput.value);
                localStorage.setItem('zimage_stash_width', widthInput.value);
                localStorage.setItem('zimage_stash_height', heightInput.value);
                localStorage.setItem('zimage_stash_seed_mode', seedRandomRadio.checked ? 'random' : 'fixed');
                localStorage.setItem('zimage_stash_seed_value', seedInput.value);
                localStorage.setItem('zimage_stash_precision', precisionInput.value);
                restoreDraftBtn.classList.remove('d-none');
            }
            isDirty = false; // Now we are in "clean" history state

            promptInput.value = item.prompt;
            stepsInput.value = item.steps;
            stepsVal.textContent = item.steps;
            widthInput.value = item.width;
            heightInput.value = item.height;
            
            // Restore Seed: Always display the seed value, but default to Random mode
            if (item.seed !== null && item.seed !== undefined) {
                seedInput.value = item.seed; // Populate the value
            } else {
                seedInput.value = ''; // Clear if no seed
            }
            seedRandomRadio.checked = true; // Force Random mode
            updateSeedState(); // Update disabled state and local storage consistently
            
            // Save to local storage as if user typed it (sync state)
            localStorage.setItem('zimage_prompt', item.prompt);
            localStorage.setItem('zimage_steps', item.steps);
            localStorage.setItem('zimage_width', item.width);
            localStorage.setItem('zimage_height', item.height);
            // Note: Precision is NOT restored from history to avoid overriding user preference

            // Show preview
            const imageUrl = `/outputs/${item.filename}`;
            
            previewContainer.innerHTML = '';
            const img = new Image();
            img.src = imageUrl;
            img.className = 'img-fluid';
            img.style.cursor = 'pointer';
            img.onclick = () => {
                modalImage.src = data.image_url; // BUG: this line is problematic in history load context. 'data' is not defined.
                // Should use imageUrl. But wait, the onclick handler in loadFromHistory was already there.
                // Let's fix it.
                modalImage.src = imageUrl;
                imageModal.show();
            };
            previewContainer.appendChild(img);
            
            downloadBtn.href = imageUrl;
            
            // Format meta info using current translations
            const t = translations[languageSelect.value];
            timeTaken.textContent = t.time_taken.replace('{0}', formatValueWithOneDecimal(item.generation_time));
            metaDims.textContent = `${item.width}x${item.height}`;
            metaSize.textContent = formatFileSize(item.file_size_kb, languageSelect.value);
            metaSeed.textContent = `${translations[languageSelect.value].seed_label}: ${item.seed}`;
            metaPrecision.textContent = `${item.precision || 'full'}`; // Default to 'full' for old entries
            metaSteps.textContent = `${item.steps} ${t.steps_label}`;
            
            resultInfo.classList.remove('d-none');
            
            // Close drawer if on mobile OR if not pinned
            if (!isHistoryPinned || window.innerWidth < 992) {
                const drawer = bootstrap.Offcanvas.getInstance(document.getElementById('historyDrawer'));
                if (drawer) drawer.hide();
            }
        }

        restoreDraftBtn.onclick = () => {
            if (localStorage.getItem('zimage_stash_prompt')) {
                promptInput.value = localStorage.getItem('zimage_stash_prompt');
                localStorage.setItem('zimage_prompt', promptInput.value);
            }
            if (localStorage.getItem('zimage_stash_steps')) {
                stepsInput.value = localStorage.getItem('zimage_stash_steps');
                stepsVal.textContent = stepsInput.value;
                localStorage.setItem('zimage_steps', stepsInput.value);
            }
            if (localStorage.getItem('zimage_stash_width')) {
                widthInput.value = localStorage.getItem('zimage_stash_width');
                localStorage.setItem('zimage_width', widthInput.value);
            }
            if (localStorage.getItem('zimage_stash_height')) {
                heightInput.value = localStorage.getItem('zimage_stash_height');
                localStorage.setItem('zimage_height', heightInput.value);
            }
            if (localStorage.getItem('zimage_stash_precision')) {
                precisionInput.value = localStorage.getItem('zimage_stash_precision');
                localStorage.setItem('zimage_precision', precisionInput.value);
            }
            if (localStorage.getItem('zimage_stash_seed_mode')) {
                const stashSeedMode = localStorage.getItem('zimage_stash_seed_mode');
                if (stashSeedMode === 'fixed') {
                    seedFixedRadio.checked = true;
                    seedInput.value = localStorage.getItem('zimage_stash_seed_value');
                } else {
                    seedRandomRadio.checked = true;
                }
                updateSeedState();
            }
            restoreDraftBtn.classList.add('d-none');
            isDirty = true; // Restored draft is dirty by definition
        };

        // Load history on startup
        loadHistory();

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const currentLang = languageSelect.value;
            const t = translations[currentLang];
            
            isDirty = false; // Generation commits the state
            restoreDraftBtn.classList.add('d-none'); // Clear stash option on new generation
            
            // Determine Seed
            let seedVal = null;
            if (seedFixedRadio.checked) {
                seedVal = parseInt(seedInput.value);
                if (isNaN(seedVal)) seedVal = Math.floor(Math.random() * 2147483647);
            } else {
                // Random mode: Generate client-side to ensure history reproducibility
                seedVal = Math.floor(Math.random() * 2147483647);
            }
            
            // UI Loading State
            generateBtn.disabled = true;
            generateBtn.textContent = t.generating_btn;
            previewContainer.innerHTML = `
                <div class="d-flex flex-column align-items-center">
                    <div class="spinner-border text-primary loading-spinner" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <div class="mt-2 text-muted small" id="runningTimer">0.0s</div>
                    <div class="mt-1 text-muted small">Seed: ${seedVal}</div>
                </div>
            `;
            resultInfo.classList.add('d-none');

            // Start Timer
            const startTime = Date.now();
            const timerEl = document.getElementById('runningTimer');
            if (timerInterval) clearInterval(timerInterval);
            timerInterval = setInterval(() => {
                const elapsed = (Date.now() - startTime) / 1000;
                if (timerEl) timerEl.textContent = formatValueWithOneDecimal(elapsed) + 's';
            }, 100);

            const payload = {
                prompt: document.getElementById('prompt').value,
                steps: parseInt(document.getElementById('steps').value),
                width: parseInt(document.getElementById('width').value),
                height: parseInt(document.getElementById('height').value),
                seed: seedVal,
                precision: precisionInput.value
            };

            try {
                const response = await fetch('/generate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                clearInterval(timerInterval); // Stop timer

                if (!response.ok) throw new Error('Generation failed');

                const data = await response.json();
                
                // Update UI with result
                const img = new Image();
                img.onload = () => {
                    previewContainer.innerHTML = '';
                    img.style.cursor = 'pointer'; // Make the preview image clickable
                    img.onclick = () => {
                        modalImage.src = data.image_url;
                        imageModal.show();
                    };
                    previewContainer.appendChild(img);
                    
                    downloadBtn.href = data.image_url;
                    
                    // Format meta info
                    timeTaken.textContent = t.time_taken.replace('{0}', formatValueWithOneDecimal(data.generation_time));
                    metaDims.textContent = `${data.width}x${data.height}`;
                    metaSize.textContent = formatFileSize(data.file_size_kb, languageSelect.value);
                    metaSeed.textContent = `${t.seed_label}: ${data.seed}`;
                    metaPrecision.textContent = `${data.precision}`;
                    
                    resultInfo.classList.remove('d-none');
                    
                    generateBtn.disabled = false;
                    generateBtn.textContent = t.generate_btn;
                    
                    // Refresh history
                    loadHistory();
                };
                img.onerror = () => {
                     throw new Error('Failed to load image');
                }
                img.src = data.image_url;

            } catch (err) {
                clearInterval(timerInterval); // Stop timer on error
                console.error(err);
                previewContainer.innerHTML = `<div class="text-danger">Error: ${err.message}</div>`;
                generateBtn.disabled = false;
                generateBtn.textContent = t.generate_btn;
            }
        });

        // Initialize tooltips on page load
        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
        var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
          return new bootstrap.Tooltip(tooltipTriggerEl)
        })
    </script>
</body>
</html>
